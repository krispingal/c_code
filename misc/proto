.TH man2html 2
.SH NAME
man2html \- butler to access troff-based man pages via the web
.SH SYNOPSIS
.EX
implement Butler;

include "bool.m";
include "butler.m";

jeeves = load Butler /dis/svc/butler/man2html.dis;

jeeves->init(pa: Pantry): (bool, bool);
jeeves->serve(s: ref Session): bool;
.EE
.SH DESCRIPTION
.L man2html
is a web butler that provides access to troff-based man pages via a web browser.
It is invoked by the HTTP dÃ¦mon
.RL ( httpd )
on a man page server, invisible to the end user,
when certain URLs are accessed via the web.
In addition to rendering individual man pages into HTML,
.L man2html
displays index pages for sets of man pages.
The index pages allow searching by any combination
of package, page name, type, and keyword(s),
with multiple space-separated keywords ANDed together.
.PP
The general pattern of URLs processed by
.L man2html
is as follows:
.IP
.LI "http://" domain / base / section / page
.br
.LI "http://" domain / base /? search
.PP
On man page servers hosting multiple packages
(indicated to
.L man2html
by the presence of a
.L .packages
file in the
.I base
directory), the URL pattern is expanded to include the package's name:
.IP
.LI "http://" domain / base / package / section / page
.PP
If a search is requested,
.L man2html
searches for matching man pages.
If exactly one is found, it is displayed,
otherwise a list of matching pages is displayed.
.PP
If no search is specified, the
.I uri
portion of the URL determines what information is displayed.
If
.I uri
names a directory,
.L man2html
lists the contents of that directory (each entry of which is presented as a hot link),
preceded by search fields and links.
.PP
If
.I uri
is the pathname of a man page,
.L man2html
finds the file containing that man page and
interprets the file according to a slightly extended set of man page macros
(based on
.LR plan9/man (6)),
rendering it into HTML suitable for viewing with a normal web browser.
Embedded references to other man pages are rendered as hot links.
.PP
At the top and bottom of every HTML page,
.L man2html
identifies the information presented on that page in a pathname format.
Each component of this pathname is a hot link to a corresponding index.
.PP
At the bottom of any HTML page presenting the contents of a single file
(whether a specific man page or the index of a single section),
.L man2html
also displays the last modification date of that file.
.PP
Man pages are comprised of Unicode text.
Note that some web browsers specify base point sizes separately both
for different character sets (which may not be set well for Unicode)
and for fixed-width (monospace) vs. variable-width fonts.
Man pages make extensive use of both fixed and variable widths;
the best rendering is generally obtained using the same base for both widths.
.SS Special Macro Processing
Several macros receive special processing from
.LR man2html .
.IP "\fBHot Links\fP"
Within a man page, references to other man pages are rendered as hot links
if they have one of the following forms in the source:
.EX
	.IR \fIname\fP (\fIdigit\fP)\fIpunct\fP
	.BR \fIpackage\fP/\fIname\fP (\fItype\fP)\fIpunct\fP
	.LR \fIpackage\fP/\fIname\fP (\fItype\fP)\fIpunct\fP
.EE
In these requests, the
.IR digit , 
.IR punct ", or"
.I type
may be nil.
The first, and older, form references the file
.IL digit / name
(e.g.,
.LR ls (1)),
while the second form references the file
.IL package / type / name
(e.g.,
.LR inferno/man2html (2)).
If the reference is to another page within the same
.IR package ,
the
.IL package /
prefix may be omitted.
.IP "\fBNative troff Commands\fP"
In addition to the
.L man
formatting macros described in
.LR plan9/man (6),
.L man2html
will also process the following directives native to
.LR troff :
.sp
.L .br
.br
Generate a break in the output.
.sp
.L .fi
.br
.L .nf
.br
Turn fill mode on and off (on by default).
.sp
.L .ft
[
.I font
]
.br
Switch font to
.I font
.RL ( P
by default).
.sp
.L .sp
[
.I x
]
.br
Insert a break into the output stream,
followed by
.I n
paragraph separations, where
.I n
is the largest integer â‰¤
.LR x ,
if a numeric value
.I x
is present, or 1 otherwise.
Unlike
.LR .PP ,
.L .sp
continues at the same indentation level,
which is particularly useful as a way to continue indented paragraphs generated with
.L .IP
(such as this one).
.sp
.L .ti
.br
In troff, specifies a temporary indentation.
Here, simply causes a break.
.SS Configuration
Several files are used to control
.LR man2html .
The man page server's
.LR rewrite (6)
file is used by
.LR httpd (8)
to designate what URLs should be served by the
.L man2html
butler.
Correspondingly,
.L httpd
uses a namespace file to bind the desired manuals
into the file tree it serves for that domain.
.PP
The
.LR .title ,
.LR .types ,
and (for multi-package servers)
.L .packages
files must be created in the
.I base
directory (root of the man page tree).
The formats of these files are explained briefly below.
.PP
The
.L .index
and
.L .contents
files in each
.I section
are created by
.LR plan9/mkindex (8).
The
.L .search
file in the
.I base
directory is created by
.LR plan9/mksearch (8).
These two commands are typically invoked by a
.LR mkfile ,
which can be invoked, e.g., by a nightly
.LR plan9/cron (8)
job if the contents of the manuals are actively evolving.
.SS Calling Sequence
The
.L init
function should be called once after the module is loaded;
the first of the two return values reports the success of initialization,
while the second reports whether this butler is one that can safely
be cached without reloading between calls to its
.L serve
function.
The main entry point,
.LR serve ,
may be called only if the initialization succeded.
The processing request is presented via the
.L session
argument to
.LR serve ,
typically reflecting an HTTP request that has been processed by
.LR httpd (8).
The
.L serve
function is re-entrant, allowing it to be called repeatedly and concurrently
to service multiple requests; it returns
.L true
unless it encounters an internal error that indicates it may no longer be safe
to re-use this instance of the module.
.SH EXAMPLES
The Plan 9 and Inferno man pages are available on the Internet at
.LR http://9srv.net/man/ .
.PP
On the multi-package
.L 9srv.net
server, the Inferno manual alone 
is displayed by including its name as a
.L package
in the URL:
.LR http://9srv.net/man/inferno/ .
.PP
This individual man page is available at this URL:
.LR http://9srv.net/man/inferno/2/man2html .
.SH FILES
.TP 12
.I base
The pathname to the root of the tree of man pages, typically
.LR /lib/man .
It must map to a single-component pathname (no internal
.LR / 's)
in the URL (typically
.LR /man ).
This mapping is controlled by
.LR httpd (8).
.TP
.IL base /.title
The title of the manual (or set of manuals) being displayed
.TP
.IL base /.packages
A list of the top-level packages for which manuals are available.
For each manual, several lines may appear.
The first line contains, at a minimum, the manual name;
all additional text on the line is used as a short description of the package.
One or more indented lines may follow, each beginning with
.LR .PM ,
giving a default proprietary marking for the pages of that manual.
If the manual name is itself indented,
that manual is presented in the search functions as a supplement
to the most recently preceding manual whose name was \fBnot\fP indented.
.TP
.IL base /.types
.TP
.IL base / package /.types
A list of the types of man pages lower in the tree.
Each line describes one section:
.br
.IL code : " multi word description"
.TP
.LI .../ section /.index
Index of interface names and the files in which they are documented
within a
.I section
of a manual
.TP
.LI .../ section /.contents
Table of contents of the interfaces described in the
.I section
of a manual
.TP
.L /lib/man/plan9
man pages for Plan 9
.TP
.L /lib/man/inferno
man pages for Inferno
.SH SOURCE
.L /appl/svc/butler/man2html.b
.SH SEE ALSO
.LR logger (1),
.LR template (1),
.LR butler (2),
.LR httpd (8),
.LR rewrite (8),
.br
.LR plan9/man (1),
.LR plan9/lookman (1),
.LR plan9/man (6),
.LR plan9/mkindex (8),
.LR plan9/mksearch (8),
.SH DIAGNOSTICS
The
.L man2html
butler participates in Inferno system logging (see
.LR logger (1))
with the component tag of
.LR httpd/man2html .
All diagnostic and trace information is presented there.
.SH HISTORY
This Limbo version of
.L man2html
is remotely based on a C version originally written by David Presotto.
Translated into Limbo and extensively revised by Paul Lustgarten.
.SH BUGS
It's possible to confuse
.L man2html
with even moderately complex
.L troff
constructs; no attempt is made to render tables.
.PP
Proper display of Unicode characters is at the mercy of the user's web browser,
which is not always up to the task.
.PP
There's no mechanism for recognizing arbitrary URLs within man pages
and presenting them as hot links.
.PP
Macros used to modify a single subsequent line of text (as can be done with
.L .SM
or the font-changing macros such as
.LR .I )
that appear within an example may not honor white space correctly.
.PP
Commands, such as font changes, embedded in a description are not processed
when displaying the index of a directory or results of a search.
.PP
White space is not always processed the same as in troff;
in particular, tabs within a no-fill section in a variable-width font
do not line up correctly.
.PP
In-line font changes with
.L \ef
that appear within the arguments to a font macro (e.g.,
.L .B
or
.LR .LR )
don't work in all cases.
